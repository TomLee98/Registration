classdef opTree < handle
    %OPTREE This class defines a tree which stored a structured tree 
    % comes from regohm object 

    properties (Access = public, Dependent)
        OhmgrProperties
    end
    
    properties (Access = private, Hidden)
        tree    (1,1)   struct
    end
    
    methods
        function this = opTree(root, ds)
            %OPTREE A constructor
            arguments
                root    (1,1)   matlab.ui.container.Tree
                ds      (1,1)   struct
            end

            % use recursion to copy the Tree
            % generate struct dynamically
            this.tree.Type = 'tree';
            this.tree.Tag = '';
            this.tree.PrivateProperties = ds;
            this.tree.Children = cell(1, numel(root.Children));
            for k = 1:numel(root.Children)
                this.tree.Children{k} = opTree.treeNodesToStruct(root.Children(k));
            end
        end
        
        % This function restores uitree on given tree root
        function root = RestoreUITree(this, root, cm)
            arguments
                this
                root    (1,1)   matlab.ui.container.Tree
                cm      (1,1)   matlab.ui.container.ContextMenu
            end

            for k = 1:numel(this.tree.Children)
                % add children to root
                opTree.structToTreeNode(root, cm, this.tree.Children{k});
            end
        end

        function r = get.OhmgrProperties(this)
            r = this.tree.PrivateProperties;
        end
    end

    methods (Static)
        function tree = treeNodesToStruct(node)
            arguments
                node    (1,1)   matlab.ui.container.TreeNode
            end
            % 将uitree及其所有子节点转换为结构体
            % 输入：root - 树对象（uitree）
            % 输出：tree - 包含所有节点信息的结构体
            % generated by 豆包 AI

            % 获取当前节点的基本属性
            tree = struct();
            tree.Text = node.Text;
            tree.Tag = node.Tag;
            tree.Type = 'treenode';
            tree.NodeData = node.NodeData;

            % 递归处理子节点
            if ~isempty(node.Children)
                children = node.Children;
                childStructs = cell(1, length(children));

                for i = 1:length(children)
                    childStructs{i} = opTree.treeNodesToStruct(children(i));
                end

                tree.Children = childStructs;
            else
                tree.Children = []; % 无子节点时设为空
            end
        end

        function structToTreeNode(pNode, cm, ns)
            arguments
                pNode   (1,1)   % matlab.ui.container.TreeNode or  matlab.ui.container.Tree
                cm      (1,1)   matlab.ui.container.ContextMenu
                ns      (1,1)   struct
            end

            % 创建当前节点
            cNode = uitreenode(pNode, "Text",ns.Text, "NodeData",ns.NodeData, ...
                "ContextMenu",cm);
            cNode.Tag = ns.Tag;

            % TODO: validate if disk file lost?

            % 递归添加子节点
            if ~isempty(ns.Children)
                for k = 1:length(ns.Children)
                    opTree.structToTreeNode(cNode, cm, ns.Children{k});
                end
            else
                % skip
            end
        end
    end
end

